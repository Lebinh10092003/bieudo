<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thực Hành Tin Học: Biểu Đồ</title>
    
    <!-- 1. Tải CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải trước style của SweetAlert2 để đảm bảo giao diện đẹp ngay lập tức -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui/material-ui.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Nunito', sans-serif; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw;
            background: linear-gradient(135deg, #e0f2fe 0%, #eef2ff 100%);
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .swal2-popup { font-family: 'Nunito', sans-serif !important; font-size: 0.9rem !important; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>

    <!-- 2. CẤU HÌNH IMPORT MAP -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.292.0",
                "sweetalert2": "https://esm.sh/sweetalert2@11", 
                "html2canvas": "https://esm.sh/html2canvas@1.4.1"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="flex flex-col items-center pt-2 md:pt-4">

    <div id="root" class="w-full max-w-7xl h-[88vh] px-2 md:px-4 flex flex-col"></div>

    <script type="text/babel" data-type="module">
        import React, { useState } from 'react';
        import { createRoot } from 'react-dom/client';
        import Swal from 'sweetalert2';
        import html2canvas from 'html2canvas';
        import { 
            BarChart3, Image as ImageIcon, Trash2, Plus, RotateCcw, 
            Star, Heart, Smile, Sun, Cloud, Moon, Zap, Music,
            Monitor, FileEdit, Trophy, Lightbulb, Table2, Download
        } from 'lucide-react';

        const PRESET_COLORS = [
            '#ef4444', // Red (Táo)
            '#f59e0b', // Yellow (Chuối)
            '#f97316', // Orange (Cam)
            '#10b981', // Green
            '#3b82f6', // Blue
            '#8b5cf6', // Purple
            '#ec4899', // Pink
            '#06b6d4', // Cyan
        ];

        const INITIAL_DATA = [
            { id: 1, label: 'Táo', value: 10, color: '#ef4444' },
        ];

        function App() {
            const [chartTitle, setChartTitle] = useState('Biểu đồ loại hoa quả yêu thích');
            const [data, setData] = useState(INITIAL_DATA);
            const [chartType, setChartType] = useState('bar'); 
            const [studentRemark, setStudentRemark] = useState('');
            // Mặc định vẫn là ngôi sao vì thanh chọn đã bị ẩn
            const [pictoIcon, setPictoIcon] = useState('star');
            const [activeTab, setActiveTab] = useState('input');
            
            const addRow = () => {
                const newId = data.length > 0 ? Math.max(...data.map(d => d.id)) + 1 : 1;
                const randomColor = PRESET_COLORS[newId % PRESET_COLORS.length];
                setData([...data, { id: newId, label: `Mục ${newId}`, value: 1, color: randomColor }]);
            };

            const deleteRow = (id) => {
                if (data.length <= 1) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Không thể xóa!',
                        text: 'Cần ít nhất 1 dòng dữ liệu để vẽ biểu đồ.',
                        confirmButtonText: 'Đã hiểu',
                        confirmButtonColor: '#f59e0b'
                    });
                    return;
                }
                setData(data.filter(item => item.id !== id));
            };

            const updateRow = (id, field, value) => {
                const newData = data.map(item => {
                    if (item.id === id) {
                        const finalValue = field === 'value' ? Math.max(0, Number(value)) : value;
                        return { ...item, [field]: finalValue };
                    }
                    return item;
                });
                setData(newData);
            };

            const updateColor = (id, newColor) => {
                setData(data.map(item => item.id === id ? { ...item, color: newColor } : item));
            };

            const resetAll = () => {
                Swal.fire({
                    title: 'Bạn có chắc chắn?',
                    text: "Dữ liệu sẽ được khôi phục về trạng thái ban đầu!",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3b82f6',
                    cancelButtonColor: '#ef4444',
                    confirmButtonText: 'Đồng ý, làm lại!',
                    cancelButtonText: 'Hủy bỏ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        setChartTitle('Biểu đồ loại hoa quả yêu thích');
                        setData(INITIAL_DATA);
                        setChartType('bar');
                        setPictoIcon('star');
                        setStudentRemark('');
                        setActiveTab('input');
                        
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true
                        });
                        Toast.fire({
                            icon: 'success',
                            title: 'Đã khôi phục dữ liệu!'
                        });
                    }
                });
            };

            const downloadChart = async () => {
                const element = document.getElementById('chart-capture-area');
                if (!element) return;

                try {
                    Swal.fire({
                        title: 'Đang tạo ảnh...',
                        text: 'Vui lòng đợi trong giây lát',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    await new Promise(resolve => setTimeout(resolve, 500));

                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        logging: false
                    });

                    const image = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `${chartTitle || 'bieu-do-cua-em'}.png`;
                    link.click();

                    Swal.close();
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true
                    });
                    Toast.fire({
                        icon: 'success',
                        title: 'Đã tải ảnh về máy!'
                    });

                } catch (error) {
                    console.error("Lỗi:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Có lỗi xảy ra',
                        text: 'Không thể tạo ảnh. Vui lòng thử lại.',
                    });
                }
            };

            const getIconComponent = (iconName, color, size = 20) => {
                const props = { size, color, fill: color, className: "inline-block mr-1 drop-shadow-sm" };
                switch (iconName) {
                    case 'heart': return <Heart {...props} />;
                    case 'smile': return <Smile {...props} />;
                    case 'sun': return <Sun {...props} />;
                    case 'cloud': return <Cloud {...props} />;
                    case 'moon': return <Moon {...props} />;
                    case 'zap': return <Zap {...props} />;
                    case 'music': return <Music {...props} />;
                    case 'star': default: return <Star {...props} />;
                }
            };

            const maxVal = Math.max(...data.map(d => d.value), 1);
            const gridMax = Math.ceil(maxVal / 5) * 5 || 5;

            return (
                <div className="h-full flex flex-col gap-4 bg-white/60 backdrop-blur-sm p-4 rounded-2xl shadow-xl border border-white/50">
                    <header className="shrink-0 bg-white px-5 py-3 rounded-xl shadow-sm border border-indigo-100 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-100 p-2 rounded-lg text-indigo-600">
                                <Monitor size={24} />
                            </div>
                            <h1 className="text-xl font-bold text-indigo-800 uppercase tracking-wide">Thực Hành Tin Học</h1>
                        </div>
                        <div className="text-sm font-semibold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-md">Bài tập: Tạo Biểu Đồ</div>
                    </header>

                    <div className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 min-h-0">
                        <div className="lg:col-span-4 flex flex-col h-full overflow-hidden bg-white/40 backdrop-blur-sm rounded-xl border border-white shadow-sm p-1.5 gap-2">
                            <div className="flex bg-slate-200/50 p-1 rounded-xl shrink-0">
                                <button onClick={() => setActiveTab('input')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'input' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700 hover:bg-white/50'}`}>
                                    <Table2 size={16} /> Nhập Liệu
                                </button>
                                <button onClick={() => setActiveTab('remarks')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'remarks' ? 'bg-white text-yellow-700 shadow-sm' : 'text-slate-500 hover:text-slate-700 hover:bg-white/50'}`}>
                                    <FileEdit size={16} /> Nhận Xét
                                </button>
                            </div>

                            {activeTab === 'input' && (
                                <div className="flex-1 bg-white p-4 rounded-xl shadow-sm border border-indigo-50 flex flex-col min-h-0 animate-in">
                                    <div className="flex justify-between items-center mb-3 pb-2 border-b border-slate-50">
                                        <h2 className="text-lg font-bold text-indigo-900">Bảng Số Liệu</h2>
                                        
                                        <button onClick={resetAll} className="text-sm flex items-center gap-2 text-red-600 bg-red-50 border border-red-200 hover:bg-red-100 hover:text-red-700 px-4 py-2 rounded-lg transition-all font-bold shadow-sm hover:shadow-md">
                                            <RotateCcw size={16} /> Làm lại
                                        </button>
                                    </div>
                                    <div className="flex-1 flex flex-col gap-3 min-h-0">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1 ml-1">Tên biểu đồ</label>
                                            <input type="text" value={chartTitle} onChange={(e) => setChartTitle(e.target.value)} className="shrink-0 w-full px-4 py-2.5 bg-indigo-50/50 border border-indigo-100 rounded-lg text-xl font-bold text-indigo-900 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all placeholder-indigo-300" placeholder="Nhập tên biểu đồ..." />
                                        </div>
                                        <div className="flex-1 overflow-y-auto border border-slate-200 rounded-lg shadow-inner bg-slate-50/30">
                                            <table className="w-full text-sm border-collapse">
                                                <thead className="bg-slate-100 text-slate-600 font-bold sticky top-0 z-10 shadow-sm">
                                                    <tr>
                                                        <th className="py-3 px-3 text-left">Tên nhóm</th>
                                                        <th className="py-3 px-2 text-center w-20">Số lượng</th>
                                                        <th className="py-3 px-2 text-center w-14">Màu</th>
                                                        <th className="py-3 px-2 text-center w-10"></th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white">
                                                    {data.map((row, idx) => (
                                                        <tr key={row.id} className="hover:bg-indigo-50 border-b border-slate-100 last:border-0 transition-colors">
                                                            <td className="p-2"><input type="text" value={row.label} onChange={(e) => updateRow(row.id, 'label', e.target.value)} className="w-full bg-transparent border-b border-transparent focus:border-indigo-300 outline-none font-semibold text-slate-700 px-1 py-1 text-lg" /></td>
                                                            <td className="p-2"><input type="number" min="0" value={row.value} onChange={(e) => updateRow(row.id, 'value', e.target.value)} className="w-full bg-indigo-50 rounded border-none focus:ring-1 focus:ring-indigo-300 outline-none font-bold text-center text-slate-800 py-1 text-lg" /></td>
                                                            <td className="p-2 text-center"><input type="color" value={row.color} onChange={(e) => updateColor(row.id, e.target.value)} className="w-8 h-8 rounded-full cursor-pointer border-2 border-white shadow-sm p-0" /></td>
                                                            <td className="p-2 text-center"><button onClick={() => deleteRow(row.id)} className="text-slate-300 hover:text-red-500 hover:bg-red-50 p-1.5 rounded transition-all"><Trash2 size={16} /></button></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        <button onClick={addRow} className="shrink-0 w-full py-2.5 bg-white border border-dashed border-indigo-300 rounded-lg text-indigo-600 hover:bg-indigo-50 hover:border-indigo-500 transition flex justify-center items-center gap-2 font-bold text-sm uppercase shadow-sm"><Plus size={16} /> Thêm dòng</button>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'remarks' && (
                                <div className="flex-1 bg-yellow-50/80 p-4 rounded-xl shadow-sm border border-yellow-200 flex flex-col min-h-0 animate-in">
                                    <div className="flex items-center gap-2 mb-2 shrink-0 border-b border-yellow-200/50 pb-2">
                                        <h2 className="text-lg font-bold text-yellow-800 flex items-center gap-1"><FileEdit size={20}/> Viết Nhận Xét</h2>
                                    </div>
                                    <div className="mb-3 text-sm text-yellow-900 bg-yellow-100/60 p-3 rounded-lg border border-yellow-200 shrink-0">
                                        <div className="flex items-center gap-1.5 font-bold mb-1.5 text-yellow-800"><Lightbulb size={16} /> Gợi ý cho em:</div>
                                        <ul className="list-disc list-inside space-y-1 pl-1 leading-relaxed text-xs md:text-sm">
                                            <li>Loại hoa quả nào có số lượng <strong>nhiều nhất</strong>?</li>
                                            <li>Loại hoa quả nào có số lượng <strong>ít nhất</strong>?</li>
                                            <li>Hai loại này hơn kém nhau bao nhiêu quả?</li>
                                            <li>Em có nhận xét gì về sự chênh lệch này không?</li>
                                        </ul>
                                    </div>
                                    <textarea className="flex-1 w-full p-4 rounded-xl border border-yellow-300 bg-white focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 outline-none text-slate-700 text-base resize-none leading-relaxed shadow-inner placeholder-yellow-800/30 min-h-0" placeholder="Hãy viết câu trả lời của em vào đây nhé..." value={studentRemark} onChange={(e) => setStudentRemark(e.target.value)}></textarea>
                                </div>
                            )}
                        </div>

                        <div className="lg:col-span-8 h-full flex flex-col gap-4 min-h-0">
                            <div id="chart-capture-area" className="bg-white p-5 rounded-xl shadow-sm border border-indigo-50 flex-1 flex flex-col relative min-h-0 hover:shadow-md transition-shadow">
                                <div className="flex justify-between items-start mb-2 shrink-0">
                                     <div className="flex items-center gap-2">
                                        <span className="bg-indigo-600 text-white w-6 h-6 flex items-center justify-center rounded-md text-sm shadow-sm font-bold">2</span> 
                                        <span className="text-base font-bold text-slate-500 uppercase">Khu vực hiển thị</span>
                                     </div>
                                     <button onClick={downloadChart} className="flex items-center gap-1.5 px-3 py-1.5 bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100 hover:scale-105 transition-all text-xs font-bold" title="Lưu biểu đồ thành ảnh">
                                         <Download size={14} /> Tải Ảnh
                                     </button>
                                </div>
                                
                                <h3 className="shrink-0 text-3xl font-black text-center mb-6 text-slate-800 uppercase tracking-tight drop-shadow-sm leading-tight px-4">{chartTitle}</h3>
                                
                                <div className="flex-1 relative border-b-2 border-l-2 border-slate-800 ml-10 mb-16 min-h-0 flex items-end">
                                    {chartType === 'bar' && (
                                        <div className="absolute inset-0 pointer-events-none">
                                            {[0, 1, 2, 3, 4, 5].map((i) => {
                                                const val = Math.round((gridMax / 5) * i);
                                                return (
                                                    <div key={i} className="absolute w-full border-t border-slate-100 flex items-center" style={{ bottom: `${i * 20}%` }}>
                                                        <span className="absolute -left-11 text-xs font-bold text-slate-400 w-9 text-right pr-2">{val}</span>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    )}

                                    {chartType === 'bar' && (
                                        <div className="w-full h-full flex items-end justify-around px-4 relative z-10">
                                            {data.map((item) => {
                                                const heightPercent = (item.value / gridMax) * 100;
                                                return (
                                                    <div key={item.id} className="relative flex flex-col items-center justify-end w-full group h-full">
                                                        <div style={{ height: `${heightPercent}%`, backgroundColor: item.color }} className="w-full max-w-[70px] rounded-t-lg hover:brightness-110 transition-all duration-300 cursor-pointer shadow-md relative animate-in border-t border-x border-white/20 flex justify-center items-start pt-2">
                                                            <div className="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent"></div>
                                                            {item.value > 0 && (
                                                                <span className="relative z-10 font-bold text-white text-lg drop-shadow-md">
                                                                    {item.value}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div className="absolute -bottom-14 left-1/2 -translate-x-1/2 text-lg md:text-xl font-bold text-slate-700 text-center truncate w-full max-w-[150px]" title={item.label}>{item.label}</div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}

                                    {chartType === 'picto' && (
                                        <div className="w-full h-full overflow-y-auto p-3 space-y-4 animate-in custom-scrollbar">
                                            {/* ĐÃ XÓA KHỐI CHỌN ICON VÀ TEXT CHÚ THÍCH Ở ĐÂY */}
                                            {data.map((item) => (
                                                <div key={item.id} className="flex items-start group hover:bg-slate-50 rounded-lg p-2 transition-colors">
                                                    <div className="w-28 text-right pr-4 pt-1 font-bold text-slate-700 text-base border-r-2 border-slate-200 relative shrink-0">
                                                        {item.label}
                                                        <div className="absolute -right-[5px] top-2.5 w-2 h-2 bg-slate-300 rounded-full group-hover:bg-indigo-400 transition-colors"></div>
                                                    </div>
                                                    <div className="flex-1 pl-4 pt-0.5 flex flex-wrap gap-2">
                                                        {Array.from({ length: item.value || 0 }).map((_, idx) => (
                                                            <span key={idx} className="hover:scale-125 transition-transform cursor-pointer drop-shadow-sm transform hover:-rotate-12">{getIconComponent(pictoIcon, item.color, 28)}</span>
                                                        ))}
                                                        {item.value > 0 && <span className="ml-1 font-bold text-slate-500 text-lg self-center bg-white shadow-sm px-2 rounded border border-slate-100">{item.value}</span>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="shrink-0 flex justify-center gap-6 pt-4 border-t border-slate-50">
                                    <button onClick={() => setChartType('bar')} className={`flex items-center gap-2 px-6 py-2.5 rounded-xl font-bold border-2 text-base transition-all duration-200 ${chartType === 'bar' ? 'bg-indigo-50 border-indigo-500 text-indigo-700 shadow-md scale-105' : 'bg-white border-slate-100 text-slate-400 hover:border-indigo-200 hover:text-indigo-500'}`}>
                                        <BarChart3 size={20} /> Biểu Đồ Cột
                                    </button>
                                    <button onClick={() => setChartType('picto')} className={`flex items-center gap-2 px-6 py-2.5 rounded-xl font-bold border-2 text-base transition-all duration-200 ${chartType === 'picto' ? 'bg-pink-50 border-pink-500 text-pink-700 shadow-md scale-105' : 'bg-white border-slate-100 text-slate-400 hover:border-pink-200 hover:text-pink-500'}`}>
                                        <ImageIcon size={20} /> Biểu Đồ Tranh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>